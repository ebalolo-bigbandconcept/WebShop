<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>Devis Artech Sécurité</title>
<style>
  @page {
    size: A4;
    margin: 1cm;
  }
  body {
    font-family: Arial, sans-serif;
    font-size: 12px;
    color: #222;
  }

  /* Container for header */
  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
  }
  .header img {
    height: 60px;
  }
  .header .date {
    font-size: 12px;
  }

  /* Company + Client info side by side */
  .info-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 15px;
  }
  .info-box {
    width: 48%;
  }
  .info-box strong {
    font-weight: bold;
  }

  /* Contact and legal info */
  .contact-legal {
    margin-bottom: 15px;
    font-size: 11px;
    line-height: 1.3;
  }
  .contact-legal a {
    color: #0072c6;
    text-decoration: none;
  }

  /* Main table styles */
  table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 10px;
    font-size: 12px;
  }
  th, td {
    border: 1px solid #000;
    padding: 6px 8px;
    text-align: center;
  }
  th {
    background-color: #4f688b;
    color: white;
  }
  tbody tr:nth-child(even) {
    background-color: #efefef;
  }
  td.left-align {
    text-align: left;
  }
  .line-comment {
    display: block;
    font-size: 10px;
    color: #555;
    margin-top: 2px;
    white-space: pre-wrap;
  }

  /* Totals summary table (right aligned) */
  .totals {
    width: 35%;
    float: right;
    border: none;
    border-collapse: collapse;
  }
  .totals td {
    border: 1px solid #000;
    padding: 6px 8px;
  }
  .totals tr:first-child td,
  .totals tr:nth-child(2) td {
    border-bottom: none;
  }
  .totals tr:last-child td {
    font-weight: bold;
  }
  .totals td:first-child {
    text-align: left;
  }
  .totals td:last-child {
    text-align: right;
  }

  /* VAT recap table (no bold last row) */
  .vat-recap {
    border-collapse: collapse;
  }
  .vat-recap td, .vat-recap th {
    border: 1px solid #000;
    padding: 6px 8px;
  }
  .vat-recap td:first-child { text-align: left; }
  .vat-recap td.right { text-align: right; }

  /* Payment options table */
  .payment-options {
    width: 30%;
    border-collapse: collapse;
    margin-bottom: 15px;
    margin-top: 20px;
  }
  .payment-options td, .payment-options th {
    border: 1px solid #000;
    padding: 5px 8px;
    font-size: 12px;
  }
  .payment-options th {
    font-weight: bold;
  }
  .payment-note {
    font-size: 11px;
    line-height: 1.3;
    padding-left: 32%;
    margin-top: -45px;
    margin-bottom: 30px;
  }

  .location-box {
    border: none;
    padding: 0;
    margin-top: 20px;
    width: 30%;
    clear: both;
  }
  .location-box table {
    width: 100%;
    border-collapse: collapse;
  }
  .location-box th,
  .location-box td {
    border: 1px solid #000;
    padding: 6px 8px;
    text-align: left;
  }
  .location-box th {
    background-color: #4f688b;
    color: white;
    text-align: center;
  }
  .location-box .right {
    text-align: right;
  }

  /* Footer with page number */
  footer {
    position: fixed;
    bottom: 10px;
    left: 0;
    right: 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 20px;
    font-size: 11px;
    color: #555;
  }
  .footer-center {
    flex: 1;
    text-align: center;
  }
  .footer-right {
    text-align: right;
    white-space: nowrap;
  }
  .page-number:before {
    content: "Page ";
  }
  .page-number:after {
    content: counter(page);
  }
  @page {
    counter-reset: page 1;
  }
</style>
</head>
<body>

<header class="header">
  <img src="logo.jpg" alt="Artech Sécurité Logo" />
  <div class="date">A Vitry-Le-François, Le {{ devis.date }}</div>
</header>

<section class="info-row">
  <div class="info-box">
    <strong>Artech Sécurité</strong><br />
    6 Route Varennes,<br />
    55840 Thierville Sur Meuse<br />
    06 08 78 43 81
  </div>
  <div class="info-box">
    <strong>{{ devis.client.nom }} {{ devis.client.prenom }}</strong><br />
    {{ devis.client.rue }}<br />
    {{ devis.client.code_postal }} {{ devis.client.ville }}<br />
    {{ devis.client.telephone }}
  </div>
</section>

<section class="contact-legal">
  <a href="mailto:artechsecurite@gmail.com">artechsecurite@gmail.com</a><br />
  TVA :<br />
  IBAN :<br />
  Siret : 98773262500023 APRM : 4321A
</section>

<table>
  <thead>
    <tr>
      <th>Désignation</th>
      <th>Quantité</th>
      <th>Prix Unitaire HT</th>
      <th>Prix Total HT</th>
    </tr>
  </thead>
  <tbody>
    {% for item in devis.articles %}
    {% set taux = item.taux_tva.taux if item.taux_tva and item.taux_tva.taux is not none else (item.article.taux_tva.taux if item.article and item.article.taux_tva and item.article.taux_tva.taux is not none else 0) %}
    {% set designation = item.article.nom ~ (' (Rénovation)' if taux == 0.10 else '') %}
    <tr>
      <td class="left-align">
        {{ designation }}
        {% if item.commentaire %}
        <span class="line-comment">{{ item.commentaire }}</span>
        {% endif %}
      </td>
      <td>{{ item.quantite or 0 }}</td>
      <td>{{ "{:.2f}".format(item.article.prix_vente_HT or 0) }}€</td>
      <td>{{ "{:.2f}".format((item.quantite or 0) * (item.article.prix_vente_HT or 0)) }}€</td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<table class="vat-recap" style="width: 30%; float: left;">
  <tr>
    <th colspan="2"><strong>Récapitulatif TVA</strong></th>
  </tr>
  {% if vat_tva_totals and 0.20 in vat_tva_totals %}
  <tr>
    <td>TVA 20%</td>
    <td class="right">{{ "{:.2f}".format(vat_tva_totals[0.20] or 0) }}€</td>
  </tr>
  {% endif %}
  {% if vat_tva_totals and 0.10 in vat_tva_totals %}
  <tr>
    <td>TVA 10%</td>
    <td class="right">{{ "{:.2f}".format(vat_tva_totals[0.10] or 0) }}€</td>
  </tr>
  {% endif %}
</table>

<table class="totals">
  <tr>
    <td>Total Hors Taxes</td>
    <td>{{ "{:.2f}".format(devis.montant_HT or 0) }}€</td>
  </tr>
  <tr>
    <td>Total TVA</td>
    <td>{{ "{:.2f}".format(devis.montant_TVA or 0) }}€</td>
  </tr>
  <tr>
    <td>Total TTC</td>
    <td>{{ "{:.2f}".format(devis.montant_TTC or 0) }} €</td>
  </tr>
</table>

{% if devis.is_location and selected_scenario %}
  {% if selected_scenario == "direct" %}
    <div style="clear: both;"></div>
    <table class="payment-options">
      <tr><th colspan="2">Total TTC</th></tr>
      <tr>
        <td>Paiement direct</td>
        <td>{{ "{:.2f}".format(payment_options.direct.total_ttc or 0) }} €</td>
      </tr>
    </table>
  {% elif selected_scenario == "location_without_apport" %}
    <div style="clear: both;"></div>
    <div class="location-box" style="margin-top: 16px;">
      <table>
        <tr><th colspan="2">Location sans apport</th></tr>
        <tr><td>Mensuel HT</td><td class="right">{{ "{:.2f}".format(payment_options.location_without_apport.monthly_ht or 0) }} €</td></tr>
        <tr><td>Mensuel TTC</td><td class="right">{{ "{:.2f}".format(payment_options.location_without_apport.monthly_ttc or 0) }} €</td></tr>
        <tr><td>Total HT</td><td class="right">{{ "{:.2f}".format(payment_options.location_without_apport.total_ht or 0) }} €</td></tr>
        <tr><td><strong>Total TTC</strong></td><td class="right"><strong>{{ "{:.2f}".format(payment_options.location_without_apport.total_ttc or 0) }} €</strong></td></tr>
      </table>
    </div>
  {% elif selected_scenario == "location_with_apport" %}
    <div style="clear: both;"></div>
    <div class="location-box" style="margin-top: 16px;">
      <table>
        <tr><th colspan="2">Location avec apport</th></tr>
        <tr><td>Apport</td><td class="right">{{ "{:.2f}".format(payment_options.location_with_apport.apport or 0) }} €</td></tr>
        <tr><td>Mensuel HT</td><td class="right">{{ "{:.2f}".format(payment_options.location_with_apport.monthly_ht or 0) }} €</td></tr>
        <tr><td>Mensuel TTC</td><td class="right">{{ "{:.2f}".format(payment_options.location_with_apport.monthly_ttc or 0) }} €</td></tr>
        <tr><td>Total HT</td><td class="right">{{ "{:.2f}".format(payment_options.location_with_apport.total_ht or 0) }} €</td></tr>
        <tr><td><strong>Total TTC</strong></td><td class="right"><strong>{{ "{:.2f}".format(payment_options.location_with_apport.total_ttc or 0) }} €</strong></td></tr>
      </table>
    </div>
  {% endif %}
{% elif devis.is_location %}
  <div style="clear: both;"></div>
  <div class="location-box">
    <div class="location-row"><strong>Location</strong><span></span></div>
    <div class="location-row"><span>Durée</span><span>{{ location_time }} mois</span></div>
    <div class="location-row"><span>Apport</span><span>{{ "{:.2f}".format(devis.first_contribution_amount or 0) }} €</span></div>
    <div class="location-row"><span>Mensuel</span><span>{{ "{:.2f}".format(devis.location_monthly_total or 0) }} €</span></div>
    <div class="location-row"><span>Total location</span><span>{{ "{:.2f}".format(devis.location_total or 0) }} €</span></div>
  </div>
{% else %}
  <table class="payment-options">
    <tr><th colspan="2">Total TTC</th></tr>
    <tr>
      <td>Paiement direct</td>
      <td>{{ "{:.2f}".format(devis.montant_TTC or 0) }} €</td>
    </tr>
  </table>
{% endif %}

<p>Conditions générales de ventes :</p>
<p style="font-size: 11px; line-height: 1.4;">{{ general_conditions }}</p>

<footer>
  <div class="footer-center">Artech Sécurité - 6, route Varennes 55840 Thierville sur Meuse</div>
  <div class="footer-right"><span class="page-number"></span></div>
</footer>

</body>
</html>
